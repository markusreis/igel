(()=>{"use strict";class t{constructor(){const t=document.getElementById("igel-sync-button");t&&(this._dom={button:t,progressBar:document.getElementById("sync-progress"),immoCounter:document.getElementById("sync-immo-counter"),userCounter:document.getElementById("sync-user-counter"),lastUpdate:document.getElementById("sync-last-update")},this._state={loading:!1,toDownload:{immo:parseInt(this._dom.immoCounter.innerText),user:parseInt(this._dom.userCounter.innerText),total:parseInt(this._dom.immoCounter.innerText)+parseInt(this._dom.userCounter.innerText),didDownload:0}},this._config={buttonDefaultText:this._dom.button.innerText,token:igelAdminData.token,apiBase:igelAdminData.baseUrl},this._dom.button.addEventListener("click",(t=>this.run())))}async run(){this._state.loading||(this._state.loading=!0,this._dom.button.style.background="#aaa",document.documentElement.style.cursor="progress",this._dom.button.style.cursor="progress",await this.prepare())}error(t,o){console.log(t),console.log(o),this._dom.button.innerText="Fehler! Sorry! Bitte Programmierer kontaktieren!",this._dom.button.style.background="#b63838",this._dom.button.style.borderColor="#b63838",document.documentElement.style.cursor="initial",this._dom.button.style.cursor="pointer"}async _fetch(t){let o;try{const e=await fetch(t).catch((o=>this.error(o,t)));if(200!==e.status)return this.error(e,t),!1;o=await e.json()}catch(o){return this.error(o,t),!1}return o}async prepare(){this._dom.button.innerText="Sync wird vorbereitet";const t=await this._fetch(`${this._config.apiBase}sync/prepare?api_token=${this._config.token}`);!1!==t&&(this.flashNumber(this._dom.immoCounter,t.realtyToDownload.length),this.flashNumber(this._dom.userCounter,t.userToDownload.length),this._state.toDownload.immo=t.realtyToDownload.length,this._state.toDownload.user=t.userToDownload.length,this._state.toDownload.total=this._state.toDownload.immo+this._state.toDownload.user,this._state.toDownload.immo>0||this._state.toDownload.user>0?setTimeout((()=>this.downloadNextImage()),50):this.finalize())}async downloadNextImage(){this._dom.button.innerText="Bilder werden heruntergeladen...";const t=await this._fetch(`${this._config.apiBase}sync/download-media?api_token=${this._config.token}`);if(!1===t)return;const o=t.realtyToDownload.length,e=t.userToDownload.length;if(this._state.toDownload.immo!==o&&(this._state.toDownload.immo=o,this.flashNumber(this._dom.immoCounter,o)),this._state.toDownload.user!==e&&(this._state.toDownload.user=e,this.flashNumber(this._dom.userCounter,e)),this._state.toDownload.didDownload+=1,this._state.toDownload.total>0){const t=Math.max(0,Math.min(1,this._state.toDownload.didDownload/this._state.toDownload.total));this._dom.progressBar.style.width=100*t+"%"}this._state.toDownload.immo>0||this._state.toDownload.user>0?setTimeout((()=>this.downloadNextImage()),50):this.finalize()}finalize(){this._dom.button.innerText="Das hat funktioniert!",this._dom.button.style.background="#317f33",document.documentElement.style.cursor="initial",this._dom.button.style.cursor="pointer",this._dom.lastUpdate.innerText="Gerade eben...",this._state.toDownload.total=0,this._state.toDownload.didDownload=0,setTimeout((()=>{this._dom.button.style.background="#2271b1",this._dom.button.innerText=this._config.buttonDefaultText,this._dom.progressBar.style.display="none",this._dom.progressBar.style.widht="0%",setTimeout((()=>{this._dom.progressBar.style.display="block",this._dom.progressBar.style.widht="0%",this._state.loading=!1}),200)}),1e3)}flashNumber(t,o,e=!0){t.style.background=e?"#badea7":"#f69191",t.innerText=o,setTimeout((()=>t.style.background="transparent"),250)}}document.addEventListener("DOMContentLoaded",(function(){new t}))})();